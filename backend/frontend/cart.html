<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Shopping Cart - PureWave</title>
<link rel="stylesheet" href="style.css">
<style>
/* ---------- Reset & base ---------- */
body { font-family: 'Inter', 'Segoe UI', Arial, sans-serif; margin:0; background:#f5f7fa; color:#222; }

/* ---------- Navbar ---------- */
.navbar { width:100%; background:#fff; box-shadow:0 2px 8px rgba(0,0,0,0.08); position:sticky; top:0; z-index:1000; }
.nav-container { max-width:1200px; margin:auto; padding:20px; display:flex; justify-content:space-between; align-items:center; }
.logo { font-size:1.8rem; font-weight:bold; color:#222; text-decoration:none; }
.nav-links { display:flex; gap:24px; }
.nav-links a { text-decoration:none; color:#222; font-weight:600; }
.nav-links a:hover { color:#000; }

/* ---------- Sidebar ---------- */
#sidebar { position:fixed; top:0; left:-280px; width:280px; height:100%; background:#f1f2f6; box-shadow:3px 0 12px rgba(0,0,0,0.1); padding:20px; transition:left 0.3s ease; z-index:1200; }
#sidebar ul { list-style:none; padding:0; }
#sidebar ul li { margin:16px 0; }
#sidebar ul li a { text-decoration:none; color:#222; font-weight:600; }

/* ---------- Main container ---------- */
main.container { max-width:1100px; margin:40px auto; padding:0 20px; box-sizing:border-box; }

/* ---------- Page heading ---------- */
h1 { font-weight:900; font-size:2.4rem; margin-bottom:24px; letter-spacing:1.5px; border-left:6px solid #222; padding-left:18px; }

/* ---------- Cart table ---------- */
table.cart-table { width:100%; border-collapse:collapse; background:#fff; border-radius:12px; overflow:hidden; box-shadow:0 8px 28px rgba(0,0,0,0.07); transition:all 0.3s ease; }
table.cart-table thead { background:#f7f7f7; color:#222; }
table.cart-table th, table.cart-table td { padding:16px 20px; text-align:left; vertical-align:middle; font-size:1rem; transition:all 0.3s ease; }
table.cart-table th { font-weight:700; letter-spacing:0.05em; text-transform:uppercase; }

/* ---------- Product info ---------- */
.product-info { display:flex; align-items:center; gap:16px; }
.product-info img { width:80px; height:80px; object-fit:cover; border-radius:12px; box-shadow:0 4px 16px rgba(0,0,0,0.08); }
.product-info .product-name { font-weight:700; color:#222; }

/* ---------- Inputs & buttons ---------- */
input.quantity-input { width:60px; padding:6px 10px; font-size:1rem; border:1.5px solid #ccc; border-radius:8px; text-align:center; transition:border-color 0.3s ease; }
input.quantity-input:hover { border-color:#222; }
button.remove-btn { background:transparent; border:none; color:#c0392b; cursor:pointer; font-size:1.4rem; font-weight:700; transition:color 0.3s ease; }
button.remove-btn:hover { color:#e74c3c; }

/* ---------- Total row ---------- */
.total-row td { font-weight:800; font-size:1.25rem; border-top:2px solid #222; padding-top:24px; text-align:right; }
.total-row td:first-child { text-align:left; }

/* ---------- Checkout button ---------- */
.checkout-btn { display:inline-block; background:linear-gradient(135deg,#222,#3a91f5); color:#fff; padding:16px 48px; border-radius:40px; font-size:1.2rem; font-weight:700; text-decoration:none; box-shadow:0 8px 28px rgba(58,145,245,0.4); transition:transform 0.3s ease, box-shadow 0.3s ease, background 0.3s ease; cursor:pointer; width:fit-content; margin-top:24px; }
.checkout-btn:hover, .checkout-btn:focus { background:linear-gradient(135deg,#3a91f5,#222); box-shadow:0 12px 36px rgba(58,145,245,0.6); transform:scale(1.05); outline:none; }

/* ---------- Scroll animations ---------- */
.from-left { transform:translateX(-40px) scale(0.95); opacity:0; transition:all 0.8s ease; }
.show { transform:scale(1) translate(0,0); opacity:1; transition:all 0.8s ease; }

/* ---------- Responsive ---------- */
@media(max-width:768px){ table.cart-table th, table.cart-table td { padding:12px 14px; font-size:0.95rem; } input.quantity-input { width:50px; } }
</style>
</head>
<body>

<header class="navbar">
  <div class="nav-container">
    <div style="display:flex; align-items:center; gap:16px;">
      <button id="sidebarToggle" style="background:none;border:none;font-size:1.8rem;cursor:pointer;">&#9776;</button>
      <a href="index.html" class="logo">PureWave</a>
    </div>
    <nav class="nav-links">
      <a href="index.html">Home</a>
      <a href="allProducts.html">Shop</a>
      <a href="cart.html">Cart</a>
      <span id="authLinks"></span>
    </nav>
  </div>
</header>

<aside id="sidebar">
  <h2>Menu</h2>
  <ul>
    <li><a href="index.html">Home</a></li>
    <li><a href="allProducts.html">Shop</a></li>
    <li><a href="cart.html">Cart</a></li>
  </ul>
</aside>

<main class="container">
  <h1>Your Shopping Cart</h1>

  <table class="cart-table" aria-label="Shopping cart items">
    <thead>
      <tr>
        <th>Product</th>
        <th>Price</th>
        <th>Quantity</th>
        <th>Subtotal</th>
        <th>Remove</th>
      </tr>
    </thead>
    <tbody id="cart-items"></tbody>
    <tfoot>
      <tr class="total-row">
        <td colspan="3">Total</td>
        <td id="cart-total">৳ 0.00</td>
        <td></td>
      </tr>
    </tfoot>
  </table>

  <a href="checkOut.html" class="checkout-btn">Proceed to Checkout</a>
</main>

<footer style="background:#222; color:#fff; padding:40px 0; text-align:center;">
  <p style="margin:0; font-size:0.9rem;">&copy; 2025 PureWave. All rights reserved.</p>
</footer>

<script>
// Sidebar toggle
const sidebarToggle = document.getElementById('sidebarToggle');
const sidebar = document.getElementById('sidebar');
sidebarToggle.addEventListener('click', () => {
  sidebar.style.left = sidebar.style.left === '0px' ? '-280px' : '0px';
});
document.addEventListener('click', e => {
  if(!sidebar.contains(e.target) && !sidebarToggle.contains(e.target)) sidebar.style.left='-280px';
});

// User auth links
const authLinks = document.getElementById("authLinks");
const user = JSON.parse(localStorage.getItem("user"));
const defaultProfile = "pp.jpg";
if(user && user.name){
  const profileImage = user.image ? user.image : defaultProfile;
  authLinks.innerHTML = `<a href="userprofile.html" style="text-decoration:none;color:#222;font-weight:600;">
    <img src="${profileImage}" alt="Profile" style="width:32px;height:32px;border-radius:50%;vertical-align:middle;">${user.name.split(" ")[0]}</a>`;
} else {
  authLinks.innerHTML = `<a href="login.html" style="text-decoration:none;color:#222;font-weight:600;">Login</a>`;
}

// --- Cart logic ---
async function fetchCart() {
  const tbody = document.getElementById('cart-items');
  tbody.innerHTML = '';

  const token = localStorage.getItem('token');
  let cart = [];

  if(token){
    // Logged-in user
    try{
      const res = await fetch("http://localhost:3000/api/cart", {
        headers: { Authorization: `Bearer ${token}` }
      });
      const data = await res.json();
      if(data.success) cart = data.cart;
    } catch(err){ console.error(err); }
  } else {
    // Guest user
    cart = JSON.parse(localStorage.getItem('cart')) || [];
    // Fetch product info
    try{
      const res = await fetch("http://localhost:3000/api/products");
      const data = await res.json();
      cart = cart.map(item=>{
        const p = data.products.find(prod=>prod.product_id==item.product_id);
        return {...item, name:p?.name||"Unknown", price:p?.price||0, image:p?.images?.[0]||"Products/default.jpg"};
      });
    } catch(err){ console.error(err); }
  }

  renderCart(cart);
}

function renderCart(cart) {
  const tbody = document.getElementById('cart-items');
  if(cart.length===0){
    tbody.innerHTML = `<tr><td colspan="5" style="text-align:center; padding:20px;">Your cart is empty.</td></tr>`;
    document.getElementById('cart-total').textContent = `৳ 0.00`;
    return;
  }

  let total = 0;
  cart.forEach(item=>{
    const subtotal = item.price*item.quantity;
    total += subtotal;

    const tr = document.createElement('tr');
    tr.classList.add('from-left');
    tr.innerHTML = `
      <td>
        <div class="product-info">
          <img src="${item.image}" alt="${item.name}">
          <div class="product-name">${item.name} ${item.size ? '('+item.size+')':''}</div>
        </div>
      </td>
      <td>৳ ${item.price.toFixed(2)}</td>
      <td><input type="number" class="quantity-input" min="1" value="${item.quantity}" data-id="${item.cart_id||item.product_id}" data-size="${item.size||''}"></td>
      <td class="subtotal">৳ ${subtotal.toFixed(2)}</td>
      <td><button class="remove-btn" data-id="${item.cart_id||item.product_id}" data-size="${item.size||''}">&times;</button></td>
    `;
    tbody.appendChild(tr);
  });

  document.getElementById('cart-total').textContent = `৳ ${total.toFixed(2)}`;
  attachCartEvents(cart);
}

function attachCartEvents(cart) {
  const tbody = document.getElementById('cart-items');

  tbody.querySelectorAll('.quantity-input').forEach(input=>{
    input.oninput = e=>{
      const tr = e.target.closest('tr');
      const price = parseFloat(tr.children[1].textContent.replace('৳',''));
      const qty = Math.max(1, parseInt(e.target.value));
      tr.querySelector('.subtotal').textContent = `৳ ${(price*qty).toFixed(2)}`;
      updateTotal();
    };

    input.onchange = async e=>{
      const qty = Math.max(1, parseInt(e.target.value));
      const token = localStorage.getItem('token');
      const id = e.target.dataset.id;
      const size = e.target.dataset.size;
      if(token){
        await fetch(`http://localhost:3000/api/cart/${id}`, {
          method:'PUT',
          headers:{'Content-Type':'application/json', Authorization:`Bearer ${token}`},
          body:JSON.stringify({ quantity:qty })
        });
      } else {
        let localCart = JSON.parse(localStorage.getItem('cart'))||[];
        const idx = localCart.findIndex(c=>c.product_id==id && c.size==size);
        if(idx>=0){ localCart[idx].quantity=qty; localStorage.setItem('cart',JSON.stringify(localCart)); }
      }
      fetchCart();
    };
  });

  tbody.querySelectorAll('.remove-btn').forEach(btn=>{
    btn.onclick = async e=>{
      const id = btn.dataset.id;
      const size = btn.dataset.size;
      const token = localStorage.getItem('token');
      if(token){
        await fetch(`http://localhost:3000/api/cart/${id}`, { method:'DELETE', headers:{Authorization:`Bearer ${token}`} });
      } else {
        let localCart = JSON.parse(localStorage.getItem('cart'))||[];
        localCart = localCart.filter(c=>!(c.product_id==id && c.size==size));
        localStorage.setItem('cart',JSON.stringify(localCart));
      }
      fetchCart();
    };
  });
}

function updateTotal(){
  let total = 0;
  document.querySelectorAll('.subtotal').forEach(td=>total+=parseFloat(td.textContent.replace('৳','')));
  document.getElementById('cart-total').textContent = `৳ ${total.toFixed(2)}`;
}

// Initial load
fetchCart();
</script>

</body>
</html>
