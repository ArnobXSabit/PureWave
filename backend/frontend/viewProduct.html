<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Product - PureWave</title>
<link rel="stylesheet" href="style.css">
<link rel="stylesheet" href="sidebar.css">
<style>
/* ---------- Navbar ---------- */
.navbar { width: 100%; background: #fff; box-shadow: 0 2px 8px rgba(0,0,0,0.1); position: sticky; top:0; z-index:1000; }
.nav-container { max-width:1200px; margin:auto; padding:20px; display:flex; justify-content:space-between; align-items:center; }
.logo { font-size:1.8rem; font-weight:bold; color:#222; text-decoration:none; transition: color 0.3s; }
.logo:hover { color:#f07041; }
.nav-links { display:flex; gap:24px; }
.nav-links a { text-decoration:none; color:#222; font-weight:600; transition:color 0.3s ease; }
.nav-links a:hover { color:#000000; }

/* ---------- Product Detail ---------- */
.container { max-width:1200px; margin:40px auto; padding:0 20px; }
.breadcrumbs { font-size:0.9rem; color:#555; margin-bottom:18px; }
.breadcrumbs a:hover { text-decoration:underline; }

.product-detail { display:flex; flex-wrap:wrap; gap:40px; background:#fff; border-radius:16px; box-shadow:0 10px 30px rgba(0,0,0,0.05); padding:32px; margin-top:20px; }
.product-images { flex:1 1 400px; min-width:300px; display:flex; flex-direction:column; gap:12px; }
#main-product-image { width:100%; border-radius:12px; object-fit:cover; box-shadow:0 8px 20px rgba(0,0,0,0.1); transition: transform 0.4s ease, box-shadow 0.4s ease; }
#main-product-image:hover { transform:scale(1.05); box-shadow:0 12px 28px rgba(0,0,0,0.18); }
#thumbnail-container { display:flex; gap:8px; flex-wrap:wrap; margin-top:12px; }
.thumbnail { width:80px; cursor:pointer; border:2px solid transparent; border-radius:8px; transition:border 0.3s ease; }
.thumbnail:hover { border-color:#000; }

/* ---------- Product Info ---------- */
.product-info { flex:1 1 400px; display:flex; flex-direction:column; }
.product-title { font-size:2rem; font-weight:800; margin-bottom:10px; line-height:1.1; }
.product-category { font-size:0.95rem; color:#666; margin-bottom:14px; text-transform:uppercase; letter-spacing:1.2px; }
.price { font-size:1.8rem; color:#222; font-weight:700; margin-bottom:16px; }
.description { font-size:1.1rem; line-height:1.5; color:#444; margin-top:24px; }

/* ---------- Size Buttons ---------- */
.size-options { display:flex; gap:12px; margin-bottom:20px; }
.size-btn { padding:10px 20px; border:2px solid #8e8686; border-radius:40px; background:#fff; color:#000; font-weight:700; cursor:pointer; transition: all 0.3s ease, transform 0.3s ease; }
.size-btn:hover { background: linear-gradient(135deg,#3a91f5,#222); color: #fff; transform: translateY(-6px) scale(1.05); box-shadow:0 12px 32px rgba(58,145,245,0.6); border: none; }
.size-btn.active { background: linear-gradient(135deg,#222,#3a91f5); color: #fff; border: none; box-shadow:0 8px 24px rgba(58,145,245,0.4); }

/* ---------- Select Size Label ---------- */
.size-label { font-weight:600; margin-bottom:8px; display:block; }

/* ---------- Quantity ---------- */
.quantity-container { display:flex; align-items:center; gap:10px; margin-bottom:24px; }
.quantity-container button { padding:6px 12px; font-size:1rem; cursor:pointer; border:1px solid #ccc; border-radius:8px; background:#fff; transition: all 0.3s ease; }
.quantity-container input { width:60px; text-align:center; padding:6px; font-size:1rem; border:1px solid #ccc; border-radius:8px; }

/* ---------- Add to Cart ---------- */
.btn-add-cart { display:inline-block; background:linear-gradient(135deg,#222,#3a91f5); color:#fff; padding:14px 36px; font-size:1.1rem; border:none; border-radius:40px; font-weight:700; cursor:pointer; box-shadow:0 8px 24px rgba(58,145,245,0.4); transition: transform 0.3s ease, background 0.3s ease, box-shadow 0.3s ease; width:fit-content; text-align:center; margin-bottom:16px; }
.btn-add-cart:hover, .btn-add-cart:focus { background:linear-gradient(135deg,#3a91f5,#222); transform:scale(1.05); box-shadow:0 12px 32px rgba(58,145,245,0.6); outline:none; }

@media(max-width:768px){.product-detail{flex-direction:column;}.product-images,.product-info{flex:1 1 100%;}}

.thumbnail.active { border: 2px solid #000; box-shadow: 0 0 8px rgba(0,0,0,0.3); border-radius: 8px; transition: all 0.3s ease; }

/* ---------- Sidebar z-index ---------- */
#sidebar { z-index: 2000; }
</style>
</head>
<body>

<!-- Navbar -->
<header class="navbar">
  <div class="nav-container">
    <div style="display:flex; align-items:center; gap:16px;">
      <button id="sidebarToggle" style="background:none;border:none;font-size:1.8rem;cursor:pointer;">&#9776;</button>
      <a href="index.html" class="logo">PureWave</a>
    </div>
    <nav class="nav-links" id="navLinks"></nav>
  </div>
</header>

<!-- Main content -->
<main class="container">
  <nav class="breadcrumbs" id="breadcrumbs"></nav>

  <section class="product-detail">
    <div class="product-images" id="image-container"></div>

    <div class="product-info">
      <h1 class="product-title" id="product-title"></h1>
      <div class="product-category" id="product-category"></div>
      <div class="price" id="product-price"></div>

      <span class="size-label">Select Size:</span>
      <div class="size-options" id="size-options"></div>

      <div class="quantity-container">
        <button type="button" id="decrease">-</button>
        <input type="number" id="quantity" min="1" value="1" />
        <button type="button" id="increase">+</button>
      </div>

      <button type="button" class="btn-add-cart" id="add-to-cart">Add to Cart</button>
      <p class="description" id="product-description"></p>
    </div>
  </section>
</main>

<script>
// ---------- Navbar & Sidebar ----------
function checkLogin() {
  const user = JSON.parse(localStorage.getItem("user"));
  const navLinks = document.getElementById("navLinks");
  const defaultProfile = "pp.jpg";

  navLinks.innerHTML = `
    <a href="index.html">Home</a>
    <a href="allProducts.html">Shop</a>
    <a href="cart.html">Cart</a>
  `;

  if(user && user.name){
    const profileImg = user.image ? user.image : defaultProfile;
    const firstName = user.name.split(" ")[0];
    navLinks.innerHTML += `
      <a href="userprofile.html" style="text-decoration:none;color:#222;font-weight:600;">
        <img src="${profileImg}" alt="Profile" style="width:32px;height:32px;border-radius:50%;vertical-align:middle;margin-right:6px;">
        ${firstName}
      </a>
    `;
  } else {
    navLinks.innerHTML += `<a href="login.html">Login</a>`;
  }
}
checkLogin();

// Sidebar toggle
const sidebar = document.getElementById("sidebar");
document.getElementById("sidebarToggle").addEventListener("click", () => {
  sidebar.classList.toggle("active");
});
</script>

<script>
// ---------- Product Loading ----------
const urlParams = new URLSearchParams(window.location.search);
const productId = urlParams.get("id");

async function loadProduct() {
  try {
    const res = await fetch(`http://localhost:3000/api/products`);
    const data = await res.json();
    const products = data.products || [];
    const product = products.find(p => p.product_id == productId);

    if(!product) {
      document.querySelector(".product-detail").innerHTML = "<p style='font-size:1.2rem;color:#f00;'>Product not found.</p>";
      return;
    }

    // Breadcrumbs
    const breadcrumbs = document.getElementById("breadcrumbs");
    const path = [];
    if(product.grandparent_name && product.grandparent_id) path.push(`<a href="categoryProducts.html?category=${product.grandparent_id}">${product.grandparent_name}</a>`);
    if(product.parent_name && product.parent_id) path.push(`<a href="categoryProducts.html?category=${product.parent_id}">${product.parent_name}</a>`);
    if(product.category_name && product.category_id) path.push(`<a href="categoryProducts.html?category=${product.category_id}">${product.category_name}</a>`);
    path.push(`<span>${product.name}</span>`);
    breadcrumbs.innerHTML = `<a href="index.html">Home</a> &gt; ${path.join(' &gt; ')}`;

    document.getElementById("product-title").innerText = product.name;
    document.getElementById("product-category").innerText = product.category_name;
    document.getElementById("product-price").innerText = `à§³ ${product.price}`;
    document.getElementById("product-description").innerText = product.description;

    // Images
    const imageContainer = document.getElementById("image-container");
    imageContainer.innerHTML = "";
    const mainImage = document.createElement("img");
    mainImage.id = "main-product-image";
    mainImage.alt = product.name;
    mainImage.src = product.images?.[0] ? (product.images[0].startsWith("http") ? product.images[0] : `http://localhost:3000/${product.images[0]}`) : "http://localhost:3000/Products/default.jpg";
    imageContainer.appendChild(mainImage);

    const thumbContainer = document.createElement("div");
    thumbContainer.id = "thumbnail-container";
    imageContainer.appendChild(thumbContainer);

    if(product.images && product.images.length){
      product.images.forEach((img,index)=>{
        const thumb = document.createElement("img");
        thumb.src = img.startsWith("http") ? img : `http://localhost:3000/${img}`;
        thumb.alt = product.name;
        thumb.classList.add("thumbnail");
        if(index===0) thumb.classList.add("active");
        thumb.addEventListener("click", ()=>{
          mainImage.src = thumb.src;
          document.querySelectorAll(".thumbnail").forEach(t=>t.classList.remove("active"));
          thumb.classList.add("active");
        });
        thumbContainer.appendChild(thumb);
      });
    }

    // Sizes
    const sizes = ["M","L","XL","XXL"];
    const sizeContainer = document.getElementById("size-options");
    sizeContainer.innerHTML = "";
    sizes.forEach(size=>{
      const btn = document.createElement("button");
      btn.classList.add("size-btn");
      btn.dataset.size = size;
      btn.innerText = size;
      btn.addEventListener("click", ()=>{
        document.querySelectorAll(".size-btn").forEach(b=>b.classList.remove("active"));
        btn.classList.add("active");
      });
      sizeContainer.appendChild(btn);
    });

  } catch(err){
    console.error(err);
    document.querySelector(".product-detail").innerHTML = "<p style='font-size:1.2rem;color:#f00;'>Failed to load product details.</p>";
  }
}

document.addEventListener("DOMContentLoaded", loadProduct);

// Quantity buttons
const quantityInput = document.getElementById("quantity");
document.getElementById("increase").addEventListener("click",()=>{quantityInput.value = parseInt(quantityInput.value)+1;});
document.getElementById("decrease").addEventListener("click",()=>{if(parseInt(quantityInput.value)>1) quantityInput.value = parseInt(quantityInput.value)-1;});

// ---------- Add to Cart (Guest + Logged-in) ----------
document.getElementById("add-to-cart").addEventListener("click", async ()=>{
  const selectedSizeBtn = document.querySelector(".size-btn.active");
  if(!selectedSizeBtn){ alert("Please select a size!"); return; }

  const quantity = parseInt(quantityInput.value);
  const size = selectedSizeBtn.dataset.size;
  const product_id = parseInt(productId);

  // Get user token (if logged in)
  const token = localStorage.getItem("token");

  if(token){
    // Logged-in: send to server
    try{
      const res = await fetch("http://localhost:3000/api/cart",{
        method:"POST",
        headers:{
          "Content-Type":"application/json",
          "Authorization": `Bearer ${token}`
        },
        body: JSON.stringify({ product_id, quantity, size })
      });
      const data = await res.json();
      if(res.ok && data.success){
        alert("â Product added to cart!");
        window.location.href="cart.html";
      }else{
        alert("â Failed to add to cart: "+(data.message||"Unknown error"));
      }
    }catch(err){
      console.error(err);
      alert("â ï¸ Error adding to cart. Check console.");
    }
  } else {
    // Guest: store locally
    let cart = JSON.parse(localStorage.getItem("cart")) || [];
    const existing = cart.find(item=>item.product_id===product_id && item.size===size);
    if(existing){
      existing.quantity += quantity;
    } else {
      cart.push({ product_id, quantity, size });
    }
    localStorage.setItem("cart", JSON.stringify(cart));
    alert("â Product added to cart (guest)!");
    window.location.href="cart.html";
  }
});
</script>

<script src="sidebar.js"></script>
</body>
</html>
