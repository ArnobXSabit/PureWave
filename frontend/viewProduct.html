<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PureWave</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />
<link href="https://fonts.googleapis.com/css2?family=Raleway:wght@600;700;900&display=swap" rel="stylesheet">
<link rel="icon" type="image/x-icon" href="favicon.png">
<style>
/* ---------- Global Styles ---------- */
* { margin:0; padding:0; box-sizing:border-box; font-family:'Poppins', Arial, sans-serif; }
body { background:#fff; color:#333; line-height:1.6; font-size:16px; padding-top:100px; }

/* ---------- Navbar ---------- */
.navbar, .duplicate-navbar {
  width:100%; 
  background:#fff; 
  box-shadow:0 2px 8px rgba(0,0,0,0.1); 
  position:fixed; 
  top:0; 
  z-index:1000; 
}
.nav-container { display: flex; justify-content: space-between; align-items: center; gap:16px; width:100%; padding:20px; }
.nav-left { display:flex; align-items:center; gap:16px; }
.nav-left .brand { display:flex; align-items:center; gap:8px; text-decoration:none; }
.nav-left .brand-icon { height:25px; }
.nav-left .logo { font-size:1.8rem; font-weight:bold; color:#222; font-family:'Raleway', sans-serif; }

.nav-center { flex:1; display:flex; justify-content:center; align-items:center; position:relative; }
.nav-center input[type="text"] { width:100%; max-width:300px; padding:8px 12px; border:1px solid #ccc; border-radius:24px 0 0 24px; outline:none; }
.nav-center button { padding:8px 16px; border:none; background:#000; color:#fff; border-radius:0 24px 24px 0; cursor:pointer; transition: background 0.3s; }
.nav-center button:hover { background:#333; }

.nav-links { display:flex; gap:50px; align-items:center; }
.nav-links a { color:#222; font-size:1.4rem; transition: color 0.3s; position:relative; }
.nav-links a:hover { color:#3a91f5; }

.duplicate-navbar { z-index:1100; transition: transform 0.3s ease, opacity 0.3s ease; }
.duplicate-navbar.hidden { transform: translateY(-100%); opacity:0; }

/* ---------- Sidebar ---------- */
#sidebar {
  position: fixed;
  top: 100px;
  left: -400px;
  width: 400px;
  height: calc(100% - 100px);
  background: #f1f2f6;
  box-shadow: 3px 0 12px rgba(0,0,0,0.1);
  padding: 20px;
  overflow-y: auto;
  transition: left 0.3s ease;
  z-index:1200;
}
#sidebar.open { left:0; }
#sidebar ul { list-style:none; padding:0; margin:0; }
#sidebar ul ul { padding-left:20px; }
#sidebar ul li { margin:8px 0; }
#sidebar ul li a { text-decoration:none; color:#222; font-weight:600; cursor:pointer; }
.category-box { display:inline-block; width:14px; height:14px; background:#ccc; margin-right:8px; border-radius:3px; cursor:pointer; }
.category-box.active { background:#3a91f5; }

/* Footer */
footer { background:#222; color:#fff; padding:40px 0; text-align:center; font-size:0.9rem; }

/* Cart Bubble */
.nav-cart-count {
  position: absolute;
  top: -8px;
  right: -8px;
  background:#3a91f5;
  color:#fff;
  font-size:0.75rem;
  font-weight:bold;
  width:18px;
  height:18px;
  border-radius:50%;
  display:flex;
  justify-content:center;
  align-items:center;
}

/* Floating Cart */
#floatingCart {
  position: fixed;
  bottom:30px;
  right:30px;
  width:50px;
  height:50px;
  background:#3a91f5;
  color:#fff;
  border-radius:50%;
  display:flex;
  justify-content:center;
  align-items:center;
  font-size:1.5rem;
  z-index:1200;
  box-shadow:0 4px 20px rgba(0,0,0,0.3);
}
#floatingCart span { 
  position:absolute; 
  top:-8px; 
  right:-8px; 
  width:18px; 
  height:18px; 
  background:#ff0000; 
  color:#fff; 
  font-size:0.75rem; 
  border-radius:50%; 
  display:flex;
  justify-content:center;
  align-items:center;
  font-weight:bold; 
}

/* Autocomplete */
#autocomplete-list {
  position:absolute;
  background:#fff;
  border:1px solid #ccc;
  max-height:200px;
  overflow-y:auto;
  width:100%;
  top:38px;
  left:0;
  z-index:9999;
  border-radius:0 0 8px 8px;
}
#autocomplete-list div { padding:8px 12px; cursor:pointer; }
.autocomplete-active { background:#3a91f5; color:#fff; }

/*---------------------------------------------------------*/
/* ---------- Product Detail ---------- */
.container { max-width:1200px; margin:40px auto; padding:0 20px; }
.breadcrumbs { font-size:0.9rem; color:#555; margin-bottom:18px; }
.breadcrumbs a:hover { text-decoration:underline; }

.product-detail { display:flex; flex-wrap:wrap; gap:40px; background:#fff; border-radius:16px; box-shadow:0 10px 30px rgba(0,0,0,0.05); padding:32px; margin-top:20px; }
.product-images { flex:1 1 400px; min-width:300px; display:flex; flex-direction:column; gap:12px; }
#main-product-image { width:100%; border-radius:12px; object-fit:cover; box-shadow:0 8px 20px rgba(0,0,0,0.1); transition: transform 0.4s ease, box-shadow 0.4s ease; }
#main-product-image:hover { transform:scale(1.05); box-shadow:0 12px 28px rgba(0,0,0,0.18); }
#thumbnail-container { display:flex; gap:8px; flex-wrap:wrap; margin-top:12px; }
.thumbnail { width:80px; cursor:pointer; border:2px solid transparent; border-radius:8px; transition:border 0.3s ease; }
.thumbnail:hover { border-color:#000; }

/* ---------- Product Info ---------- */
.product-info { flex:1 1 400px; display:flex; flex-direction:column; }
.product-title { font-size:2rem; font-weight:800; margin-bottom:10px; line-height:1.1; }
.product-category { font-size:0.95rem; color:#666; margin-bottom:14px; text-transform:uppercase; letter-spacing:1.2px; }
.price { font-size:1.8rem; color:#222; font-weight:700; margin-bottom:16px; }
.description { font-size:1.1rem; line-height:1.5; color:#444; margin-top:24px; }

/* ---------- Size Buttons ---------- */
.size-options { display:flex; gap:12px; margin-bottom:20px; }
.size-btn { padding:10px 20px; border:2px solid #8e8686; border-radius:40px; background:#fff; color:#000; font-weight:700; cursor:pointer; transition: all 0.3s ease, transform 0.3s ease; }
.size-btn:hover { background: linear-gradient(135deg,#3a91f5,#222); color: #fff; transform: translateY(-6px) scale(1.05); box-shadow:0 12px 32px rgba(58,145,245,0.6); border: none; }
.size-btn.active { background: linear-gradient(135deg,#222,#3a91f5); color: #fff; border: none; box-shadow:0 8px 24px rgba(58,145,245,0.4); }

/* ---------- Select Size Label ---------- */
.size-label { font-weight:600; margin-bottom:8px; display:block; }

/* ---------- Quantity ---------- */
.quantity-container { display:flex; align-items:center; gap:10px; margin-bottom:24px; }
.quantity-container button { padding:6px 12px; font-size:1rem; cursor:pointer; border:1px solid #ccc; border-radius:8px; background:#fff; transition: all 0.3s ease; }
.quantity-container input { width:60px; text-align:center; padding:6px; font-size:1rem; border:1px solid #ccc; border-radius:8px; }

/* ---------- Add to Cart ---------- */
.btn-add-cart { display:inline-block; background:linear-gradient(135deg,#222,#3a91f5); color:#fff; padding:14px 36px; font-size:1.1rem; border:none; border-radius:40px; font-weight:700; cursor:pointer; box-shadow:0 8px 24px rgba(58,145,245,0.4); transition: transform 0.3s ease, background 0.3s ease, box-shadow 0.3s ease; width:fit-content; text-align:center; margin-bottom:16px; }
.btn-add-cart:hover, .btn-add-cart:focus { background:linear-gradient(135deg,#3a91f5,#222); transform:scale(1.05); box-shadow:0 12px 32px rgba(58,145,245,0.6); outline:none; }

@media(max-width:768px){.product-detail{flex-direction:column;}.product-images,.product-info{flex:1 1 100%;}}

.thumbnail.active { border: 2px solid #000; box-shadow: 0 0 8px rgba(0,0,0,0.3); border-radius: 8px; transition: all 0.3s ease; }

</style>
<!-- Main content -->
<main class="container">
  <nav class="breadcrumbs" id="breadcrumbs"></nav>

  <section class="product-detail">
    <div class="product-images" id="image-container"></div>

    <div class="product-info">
      <h1 class="product-title" id="product-title"></h1>
      <div class="product-category" id="product-category"></div>
      <div class="price" id="product-price"></div>

      <span class="size-label">Select Size:</span>
      <div class="size-options" id="size-options"></div>

      <div class="quantity-container">
        <button type="button" id="decrease">-</button>
        <input type="number" id="quantity" min="1" value="1" />
        <button type="button" id="increase">+</button>
      </div>

      <button type="button" class="btn-add-cart" id="add-to-cart">Add to Cart</button>
      <p class="description" id="product-description"></p>
    </div>
  </section>
</main>
</head>
<body>

<!-- Duplicate Navbar -->
<header class="navbar duplicate-navbar" id="duplicateNavbar">
  <div class="nav-container">
    <div class="nav-left">
      <button id="sidebarToggle2" style="background:none;border:none;font-size:1.8rem;cursor:pointer;">&#9776;</button>
      <a href="index.html" class="brand">
        <img src="icon.png" alt="Brand Icon" class="brand-icon">
        <span class="logo">PureWave</span>
      </a>
    </div>
    <div class="nav-center">
      <form id="searchForm" style="display:flex; width:100%; max-width:400px; position:relative;">
        <input type="text" id="searchInput" placeholder="Search products...">
        <button type="submit"><i class="fas fa-search"></i></button>
      </form>
    </div>
    <nav class="nav-links">
      <a href="index.html"><i class="fas fa-home"></i></a>
      <a href="products.html"><i class="fas fa-store"></i></a>
      <a href="cart.html"><i class="fas fa-shopping-cart"></i><span class="nav-cart-count" id="duplicateNavbarCartCount">0</span></a>
      <a href="userprofile.html"><i class="fas fa-user"></i></a>
    </nav>
  </div>
</header>

<!-- Original Navbar -->
<header class="navbar" id="navbar">
  <div class="nav-container">
    <div class="nav-left">
      <button id="sidebarToggle" style="background:none;border:none;font-size:1.8rem;cursor:pointer;">&#9776;</button>
      <a href="index.html" class="brand">
        <img src="icon.png" alt="Brand Icon" class="brand-icon">
        <span class="logo">PureWave</span>
      </a>
    </div>
    <nav class="nav-links">
      <a href="index.html"><i class="fas fa-home"></i></a>
      <a href="javascript:void(0);" id="navbarSearchIcon"><i class="fas fa-search"></i></a>
      <a href="products.html"><i class="fas fa-store"></i></a>
      <a href="cart.html"><i class="fas fa-shopping-cart"></i><span class="nav-cart-count" id="navbarCartCount">0</span></a>
      <a href="userprofile.html"><i class="fas fa-user"></i></a>
    </nav>
  </div>
</header>

<!-- Sidebar -->
<aside id="sidebar">
  <h2>Categories</h2>
  <ul id="sidebarCategories"></ul>
</aside>

<footer>
  &copy; 2025 PureWave. All rights reserved.
</footer>

<!-- Floating Cart -->
<a href="cart.html" id="floatingCart">
  <i class="fas fa-shopping-cart"></i>
  <span id="cartCount">0</span>
</a>

<script>
// ---------------- Base URL ----------------
const BASE_URL = window.location.hostname === "localhost" ? "http://localhost:3000" : "https://purewave.onrender.com";

// ---------------- Helper Functions ----------------
function getImageUrl(img){
    if(!img) return `${BASE_URL}/Products/default.jpg`;
    return img.startsWith("http") ? img : `${BASE_URL}/${img}`;
}

// ---------------- Duplicate Navbar Hide on Scroll ----------------
const duplicateNavbar = document.getElementById('duplicateNavbar');
let lastScroll = window.scrollY;
window.addEventListener('scroll', () => {
    const currentScroll = window.scrollY;
    if(currentScroll > lastScroll && currentScroll > 50) duplicateNavbar.classList.add('hidden');
    else duplicateNavbar.classList.remove('hidden');
    lastScroll = currentScroll;
});

// ---------------- Sidebar ----------------
async function initSidebar() {
    const sidebar = document.getElementById('sidebar');
    const sidebarToggle = document.getElementById('sidebarToggle');
    const sidebarToggle2 = document.getElementById('sidebarToggle2');

    sidebarToggle.addEventListener('click', () => sidebar.classList.toggle('open'));
    sidebarToggle2.addEventListener('click', () => sidebar.classList.toggle('open'));

    document.addEventListener('click', e => {
        if (!sidebar.contains(e.target) && !sidebarToggle.contains(e.target) && !sidebarToggle2.contains(e.target)) {
            sidebar.classList.remove('open');
        }
    });

    const selectedCategories = new Set();

    async function loadSidebarCategories() {
        try {
            const res = await fetch(`${BASE_URL}/api/categories`);
            const categories = await res.json();
            const container = document.getElementById("sidebarCategories");
            container.innerHTML = "";
            const map = {};
            categories.forEach(cat => { const pid = cat.parent_id ?? 0; if(!map[pid]) map[pid]=[]; map[pid].push(cat); });

            function createList(pid) {
                if(!map[pid]) return null;
                const ul = document.createElement('ul');
                map[pid].forEach(cat => {
                    const li = document.createElement('li');
                    const box = document.createElement('div'); box.classList.add('category-box'); box.dataset.id = cat.category_id;
                    const a = document.createElement('a'); a.textContent = cat.category_name;

                    const toggle = () => {
                        if(selectedCategories.has(cat.category_id)) { selectedCategories.delete(cat.category_id); box.classList.remove('active'); }
                        else { selectedCategories.add(cat.category_id); box.classList.add('active'); }
                        loadProducts();
                    };

                    box.addEventListener('click', e => { e.stopPropagation(); toggle(); });
                    a.addEventListener('click', e => { e.preventDefault(); toggle(); });

                    li.appendChild(box); li.appendChild(a);
                    const childUl = createList(cat.category_id); if(childUl) li.appendChild(childUl);
                    ul.appendChild(li);
                });
                return ul;
            }

            const topUl = createList(0); if(topUl) container.appendChild(topUl);
        } catch(err) { console.error(err); }
    }

    async function loadProducts() {
        const grid = document.getElementById("product-grid");
        if(!grid) return;
        grid.innerHTML = "";
        if(selectedCategories.size === 0){ grid.innerHTML="<p>Please select a category.</p>"; return; }
        const added = new Set();
        for(const catId of selectedCategories){
            const res = await fetch(`${BASE_URL}/api/products?category_id=${catId}`);
            const data = await res.json();
            if(!data.success) continue;
            data.products.forEach(p => {
                if(added.has(p.product_id)) return; added.add(p.product_id);
                const imgUrl = getImageUrl(p.images?.[0]);
                const card = document.createElement('div'); card.classList.add('product-card');
                card.innerHTML = `<a href="viewProduct.html?id=${p.product_id}"><img src="${imgUrl}" alt="${p.name}"></a><h3>${p.name}</h3><span>৳ ${p.price}</span>`;
                grid.appendChild(card);
            });
        }
    }

    await loadSidebarCategories();
}

// ---------------- Cart Count ----------------
function updateCartCount() {
    let cartItems = JSON.parse(localStorage.getItem('cart')) || [];
    const count = cartItems.length;
    ['navbarCartCount','duplicateNavbarCartCount','cartCount'].forEach(id => {
        const el = document.getElementById(id);
        if(el) el.textContent = count;
    });
}

// ---------------- Search Autocomplete ----------------
let allCategories = [];
async function loadAllCategories() {
    try{ const res = await fetch(`${BASE_URL}/api/categories`); allCategories = await res.json(); }
    catch(e){ console.error(e); }
}

const searchInput = document.getElementById('searchInput');
let currentFocus=-1;

searchInput.addEventListener('input', function() {
    closeAutocomplete();
    if(!this.value) return;
    const val=this.value.toLowerCase();
    const matches=allCategories.filter(c=>c.category_name.toLowerCase().includes(val));
    if(matches.length===0) return;
    const list = document.createElement('div'); list.setAttribute('id','autocomplete-list');
    matches.forEach(cat=>{
        const item=document.createElement('div'); item.textContent=cat.category_name;
        item.addEventListener('click', ()=>{ window.location.href=`categoryProducts.html?category=${cat.category_id}`; });
        list.appendChild(item);
    });
    this.parentNode.appendChild(list);
});

searchInput.addEventListener('keydown', function(e){
    let list=document.getElementById('autocomplete-list');
    if(list) list=list.getElementsByTagName('div');
    if(!list) return;
    if(e.key==="ArrowDown"){ currentFocus++; addActive(list); }
    else if(e.key==="ArrowUp"){ currentFocus--; addActive(list); }
    else if(e.key==="Enter"){ e.preventDefault(); if(currentFocus>-1) list[currentFocus].click(); }
});

function addActive(list){ if(!list) return; removeActive(list); if(currentFocus>=list.length) currentFocus=0; if(currentFocus<0) currentFocus=list.length-1; list[currentFocus].classList.add("autocomplete-active"); }
function removeActive(list){ for(let i=0;i<list.length;i++) list[i].classList.remove("autocomplete-active"); }
function closeAutocomplete(){ const list=document.getElementById('autocomplete-list'); if(list) list.parentNode.removeChild(list); currentFocus=-1; }
document.addEventListener('click', function(e){ if(e.target!==searchInput) closeAutocomplete(); });

document.getElementById('searchForm').addEventListener('submit', e=>{
    e.preventDefault();
    const query = searchInput.value.trim();
    if(query) window.location.href=`allProducts.html?search=${encodeURIComponent(query)}`;
});

// ---------------- Load Product ----------------
const urlParams = new URLSearchParams(window.location.search);
const productId = urlParams.get("id");

async function loadProduct() {
    if(!productId){
        document.querySelector(".product-detail").innerHTML = "<p style='color:red'>No product selected!</p>";
        return;
    }
    try{
        const res = await fetch(`${BASE_URL}/api/products/${productId}`);
        if(!res.ok) throw new Error("Product not found");
        const product = await res.json();

        // Breadcrumbs
        const breadcrumbs = document.getElementById("breadcrumbs");
        const path = [];
        if(product.grandparent_name) path.push(`<a href="categoryProducts.html?category=${product.grandparent_id}">${product.grandparent_name}</a>`);
        if(product.parent_name) path.push(`<a href="categoryProducts.html?category=${product.parent_id}">${product.parent_name}</a>`);
        if(product.category_name) path.push(`<a href="categoryProducts.html?category=${product.category_id}">${product.category_name}</a>`);
        path.push(`<span>${product.name}</span>`);
        breadcrumbs.innerHTML = `<a href="index.html">Home</a> &gt; ${path.join(' &gt; ')}`;

        // Product Info
        document.getElementById("product-title").innerText = product.name;
        document.getElementById("product-category").innerText = product.category_name;
        document.getElementById("product-price").innerText = `৳ ${product.price}`;
        document.getElementById("product-description").innerText = product.description;

        // Images
        const imageContainer = document.getElementById("image-container");
        imageContainer.innerHTML = "";
        const mainImage = document.createElement("img");
        mainImage.id = "main-product-image";
        mainImage.alt = product.name;
        mainImage.src = getImageUrl(product.images?.[0]);
        imageContainer.appendChild(mainImage);

        const thumbContainer = document.createElement("div");
        thumbContainer.id = "thumbnail-container";
        imageContainer.appendChild(thumbContainer);

        (product.images || []).forEach((img,index)=>{
            const thumb = document.createElement("img");
            thumb.src = getImageUrl(img);
            thumb.alt = product.name;
            thumb.classList.add("thumbnail");
            if(index===0) thumb.classList.add("active");
            thumb.addEventListener("click", ()=>{
                mainImage.src = thumb.src;
                document.querySelectorAll(".thumbnail").forEach(t=>t.classList.remove("active"));
                thumb.classList.add("active");
            });
            thumbContainer.appendChild(thumb);
        });

        // Sizes
        const sizeContainer = document.getElementById("size-options");
        sizeContainer.innerHTML = "";
        const sizes = product.variants?.map(v=>v.size) || ["M","L","XL","XXL"];
        sizes.forEach((size,index)=>{
            const btn = document.createElement("button");
            btn.classList.add("size-btn");
            btn.dataset.size = size;
            btn.innerText = size;
            btn.addEventListener("click", ()=>{
                document.querySelectorAll(".size-btn").forEach(b=>b.classList.remove("active"));
                btn.classList.add("active");
            });
            sizeContainer.appendChild(btn);
        });
        if(sizeContainer.firstChild) sizeContainer.firstChild.classList.add("active");

    }catch(err){
        console.error(err);
        document.querySelector(".product-detail").innerHTML = "<p style='color:red'>Failed to load product.</p>";
    }
}

// ---------------- Quantity Buttons ----------------
const quantityInput = document.getElementById("quantity");
document.getElementById("increase").addEventListener("click",()=>{ quantityInput.value = parseInt(quantityInput.value)+1; });
document.getElementById("decrease").addEventListener("click",()=>{ if(parseInt(quantityInput.value)>1) quantityInput.value = parseInt(quantityInput.value)-1; });

// ---------------- Add to Cart ----------------
document.getElementById("add-to-cart").addEventListener("click", async ()=>{
    const selectedSizeBtn = document.querySelector(".size-btn.active");
    if(!selectedSizeBtn){ alert("Please select a size!"); return; }

    const quantity = parseInt(quantityInput.value);
    const size = selectedSizeBtn.dataset.size;
    const product_id = parseInt(productId);

    const user = JSON.parse(localStorage.getItem("user"));
    const token = user?.token;

    if(token){
        try{
            const res = await fetch(`${BASE_URL}/api/cart`,{
                method:"POST",
                headers:{
                    "Content-Type":"application/json",
                    "Authorization": `Bearer ${token}`
                },
                body: JSON.stringify({ product_id, quantity, size })
            });
            const data = await res.json();
            if(res.ok && data.success){
                alert("✅ Product added to cart!");
                window.location.href="cart.html";
            }else{
                alert("❌ Failed to add to cart: "+(data.message||"Unknown error"));
            }
        }catch(err){
            console.error(err);
            alert("⚠️ Error adding to cart. Check console.");
        }
    } else {
        let cart = JSON.parse(localStorage.getItem("cart")) || [];
        const existing = cart.find(item=>item.product_id===product_id && item.size===size);
        if(existing) existing.quantity += quantity;
        else cart.push({ product_id, quantity, size });
        localStorage.setItem("cart", JSON.stringify(cart));
        alert("✅ Product added to cart (guest)!");
        window.location.href="cart.html";
    }
});

// ---------------- Initialize ----------------
document.addEventListener("DOMContentLoaded", async ()=>{
    await initSidebar();
    updateCartCount();
    await loadAllCategories();
    await loadProduct();
});
</script>

</body>
</html>
